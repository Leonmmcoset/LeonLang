# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"  # 仅在推送语义化版本标签时触发

permissions:
  contents: write  # 授予创建 GitHub Release 的权限

jobs:
  build-and-upload:
    name: Build and upload
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux 平台配置（x86_64-unknown-linux-musl 静态编译）
          - build: linux
            os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            binary_suffix: ""  # Linux 二进制无后缀
            openssl_dir: "/usr/local/musl-openssl"  # 源码编译的 OpenSSL 安装路径
            openssl_version: "3.2.1"  # 选择稳定的 OpenSSL 版本（避免兼容性问题）
          # Windows 平台配置（x86_64-pc-windows-msvc）
          - build: windows
            os: windows-latest
            target: x86_64-pc-windows-msvc
            binary_suffix: ".exe"  # Windows 二进制带 .exe 后缀
            openssl_dir: ""  # Windows 无需此配置
            openssl_version: ""  # Windows 无需此配置
      fail-fast: false  # 一个平台失败不影响另一个平台构建

    env:
      RUST_BACKTRACE: full  # 启用完整 Rust 错误回溯
      BINARY_NAME: "leonbasic"  # 二进制文件名（与 Cargo.toml 一致）
      OPENSSL_DIR: ${{ matrix.openssl_dir }}  # OpenSSL 安装路径（仅 Linux 生效）

    steps:
      # 1. 拉取代码仓库
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 提取版本号（从标签中）
      - name: Extract release version from tag
        shell: bash
        run: |
          VERSION=$(echo "${GITHUB_REF#refs/tags/}" | sed 's/^v//')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "提取的版本号：$VERSION"

      # 3. 生成归档格式变量（避免三元运算符）
      - name: Set archive format variable
        shell: bash
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            echo "ARCHIVE_FORMAT=ZIP" >> $GITHUB_ENV
          else
            echo "ARCHIVE_FORMAT=TAR.GZ" >> $GITHUB_ENV
          fi

      # 4. Windows 平台：安装 Visual C++ Build Tools
      - name: Install Visual C++ Build Tools (Windows)
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # 5. Linux 平台：源码编译安装 musl 版 OpenSSL（关键修复！）
      - name: Build and install OpenSSL for musl (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          # 5.1 安装编译依赖（基础工具 + musl 工具链）
          sudo apt-get update && sudo apt-get install -y \
            build-essential \
            wget \
            tar \
            gzip \
            musl-tools \
            pkg-config  # 后续用于识别 OpenSSL 依赖
          
          # 5.2 下载 OpenSSL 源码（从官网获取稳定版本）
          OPENSSL_URL="https://www.openssl.org/source/openssl-${{ matrix.openssl_version }}.tar.gz"
          wget -O openssl.tar.gz "$OPENSSL_URL"
          tar -xzf openssl.tar.gz
          cd openssl-${{ matrix.openssl_version }}
          
          # 5.3 配置编译参数（针对 musl 静态编译）
          # - --prefix：指定安装路径
          # - no-shared：仅生成静态库（适合 musl 静态编译）
          # - -fPIC：生成位置无关代码（避免链接错误）
          ./Configure \
            --prefix="${{ matrix.openssl_dir }}" \
            --openssldir="${{ matrix.openssl_dir }}" \
            no-shared \
            linux-x86_64 \
            -fPIC \
            -I/usr/include/musl \
            -L/usr/lib/x86_64-linux-musl
          
          # 5.4 编译并安装（-j$(nproc) 启用多线程编译，加快速度）
          make -j$(nproc)
          sudo make install
          
          # 5.5 验证安装结果（检查头文件和静态库）
          echo "=== 验证 OpenSSL 安装 ==="
          if [ -f "${{ matrix.openssl_dir }}/include/openssl/ssl.h" ] && \
             [ -f "${{ matrix.openssl_dir }}/lib/libssl.a" ] && \
             [ -f "${{ matrix.openssl_dir }}/lib/libcrypto.a" ]; then
            echo "✅ OpenSSL 源码编译安装成功！"
            ls -la "${{ matrix.openssl_dir }}/include/openssl/" | head -5
            ls -la "${{ matrix.openssl_dir }}/lib/" | grep -E "libssl|libcrypto"
          else
            echo "ERROR: OpenSSL 安装失败！缺失关键文件"
            exit 1
          fi

      # 6. 安装 Rust 工具链
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.target }}
          components: rustfmt, clippy

      # 7. 清理 Cargo 缓存
      - name: Clean Cargo cache
        shell: bash
        run: |
          cargo clean
          rm -rf ~/.cargo/registry/index/*
          rm -rf ~/.cargo/registry/cache/*

      # 8. 更新依赖并验证
      - name: Update dependencies and sync Cargo.lock
        shell: bash
        run: |
          cargo update --verbose
          if ! cargo check --target ${{ matrix.target }}; then
            echo "ERROR: 依赖解析失败！"
            grep -A 5 -B 5 "openssl-sys" Cargo.lock
            exit 1
          fi

      # 9. 编译项目（Linux 需指定 OpenSSL 路径）
      - name: Build project (native, no cross)
        uses: actions-rs/cargo@v1
        id: cargo_build
        with:
          command: build
          args: --verbose --release --target ${{ matrix.target }}
        env:
          # Linux 平台：告诉 openssl-sys 依赖路径
          OPENSSL_DIR: ${{ matrix.openssl_dir }}
          # 让 pkg-config 找到 OpenSSL 配置文件
          PKG_CONFIG_PATH: ${{ matrix.openssl_dir }}/lib/pkgconfig
          # 强制使用静态库链接（避免动态库依赖）
          OPENSSL_STATIC: "1"

      # 10. 验证编译产物
      - name: Verify build output exists
        shell: bash
        run: |
          BINARY_PATH="target/${{ matrix.target }}/release/${{ env.BINARY_NAME }}${{ matrix.binary_suffix }}"
          if [ ! -f "$BINARY_PATH" ]; then
            echo "ERROR: 产物不存在！路径：$BINARY_PATH"
            find target/ -name "${{ env.BINARY_NAME }}*"
            exit 1
          fi
          echo "✅ 产物验证通过：$BINARY_PATH"
          ls -la "$BINARY_PATH"

      # 11. 构建归档包
      - name: Build archive package
        shell: bash
        run: |
          ARCHIVE_DIR_NAME="${{ env.BINARY_NAME }}-${{ env.VERSION }}-${{ matrix.target }}"
          BINARY_PATH="target/${{ matrix.target }}/release/${{ env.BINARY_NAME }}${{ matrix.binary_suffix }}"
          mkdir -p "$ARCHIVE_DIR_NAME"
          mv "$BINARY_PATH" "$ARCHIVE_DIR_NAME/" || exit 1
          
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            ARCHIVE_FILE="${ARCHIVE_DIR_NAME}.zip"
            7z a -tzip -bb1 "$ARCHIVE_FILE" "$ARCHIVE_DIR_NAME/"
          else
            ARCHIVE_FILE="${ARCHIVE_DIR_NAME}.tar.gz"
            tar -czvf "$ARCHIVE_FILE" "$ARCHIVE_DIR_NAME/"
          fi
          echo "ASSET=$ARCHIVE_FILE" >> $GITHUB_ENV
          echo "✅ 归档包创建成功：$ARCHIVE_FILE"

      # 12. 发布到 GitHub Releases
      - name: Upload archive to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ASSET }}
          name: Release ${{ env.VERSION }}
          tag_name: ${{ github.ref_name }}
          body: |
            ## Release ${{ env.VERSION }}
            自动构建的 ${{ matrix.build }} 平台产物，目标架构：${{ matrix.target }}
            - 二进制文件：${{ env.BINARY_NAME }}${{ matrix.binary_suffix }}
            - 归档格式：${{ env.ARCHIVE_FORMAT }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}